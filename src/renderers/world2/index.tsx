import { parse } from 'solid-mds';
import { A } from '@solidjs/router';
import { ChevronLeft } from 'lucide-solid';
import { largeImageUrl } from '~/components/image-helpers';
import { World2Calculator } from '~/components/world-2-calculator';
import { canonicalComponents } from '~/components/canonical-components';
import type { GlobalScope, LocalScope } from './types';
import type { JSX } from 'solid-js/jsx-runtime';

// Graphics plugin - the SVG chart from the world-2 layout
const Graphic = () => (
  <svg
    class="w-full max-w-sm mx-auto"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 800 982"
    fill="none"
  >
    <path fill="#000" d="M0 0h800v982H0z" />
    <path
      stroke="#fff"
      stroke-width={4}
      d="M56.003 20.186V330M56.003 430.186v312.753M753.481 332H54.003M753.481 742H54.003"
    />
    <path
      fill="#fff"
      d="M55.123 362.822v-1.4a159.486 159.486 0 0 0 4.536-4.648c1.27-1.362 2.23-2.594 2.884-3.696.654-1.101.98-2.128.98-3.08 0-1.026-.28-1.866-.84-2.52-.56-.653-1.41-.98-2.548-.98-.746 0-1.437.206-2.072.616a7.922 7.922 0 0 0-1.736 1.54l-1.288-1.26c.747-.84 1.54-1.512 2.38-2.016.859-.504 1.858-.756 2.996-.756 1.102 0 2.053.224 2.856.672a4.458 4.458 0 0 1 1.848 1.82c.43.784.644 1.699.644 2.744 0 1.158-.327 2.306-.98 3.444-.635 1.139-1.512 2.334-2.632 3.584a133.537 133.537 0 0 1-3.864 4.116c.486-.056.99-.093 1.512-.112a21.074 21.074 0 0 1 1.484-.056h5.376v1.988H55.123Zm19.77.336c-1.792 0-3.201-.802-4.228-2.408-1.008-1.624-1.512-3.929-1.512-6.916 0-3.005.504-5.292 1.512-6.86 1.027-1.568 2.436-2.352 4.228-2.352 1.773 0 3.164.794 4.172 2.38 1.027 1.568 1.54 3.846 1.54 6.832 0 2.987-.513 5.292-1.54 6.916-1.008 1.606-2.398 2.408-4.172 2.408Zm0-1.848c.69 0 1.297-.261 1.82-.784.523-.522.924-1.334 1.204-2.436.299-1.101.448-2.52.448-4.256 0-1.754-.15-3.173-.448-4.256-.28-1.082-.681-1.866-1.204-2.352-.522-.504-1.13-.756-1.82-.756-.71 0-1.325.252-1.848.756-.523.486-.933 1.27-1.232 2.352-.28 1.083-.42 2.502-.42 4.256 0 1.736.14 3.155.42 4.256.299 1.102.71 1.914 1.232 2.436.523.523 1.139.784 1.848.784Zm8.066 1.512v-1.4a159.486 159.486 0 0 0 4.536-4.648c1.27-1.362 2.23-2.594 2.884-3.696.653-1.101.98-2.128.98-3.08 0-1.026-.28-1.866-.84-2.52-.56-.653-1.41-.98-2.548-.98-.747 0-1.437.206-2.072.616a7.925 7.925 0 0 0-1.736 1.54l-1.288-1.26c.747-.84 1.54-1.512 2.38-2.016.859-.504 1.857-.756 2.996-.756 1.101 0 2.053.224 2.856.672a4.457 4.457 0 0 1 1.848 1.82c.43.784.644 1.699.644 2.744 0 1.158-.327 2.306-.98 3.444-.635 1.139-1.512 2.334-2.632 3.584a133.537 133.537 0 0 1-3.864 4.116c.485-.056.99-.093 1.512-.112a21.076 21.076 0 0 1 1.484-.056h5.376v1.988H82.96Zm19.77.336c-1.792 0-3.201-.802-4.228-2.408-1.008-1.624-1.512-3.929-1.512-6.916 0-3.005.504-5.292 1.512-6.86 1.027-1.568 2.436-2.352 4.228-2.352 1.773 0 3.164.794 4.172 2.38 1.027 1.568 1.54 3.846 1.54 6.832 0 2.987-.513 5.292-1.54 6.916-1.008 1.606-2.399 2.408-4.172 2.408Zm0-1.848c.691 0 1.297-.261 1.82-.784.523-.522.924-1.334 1.204-2.436.299-1.101.448-2.52.448-4.256 0-1.754-.149-3.173-.448-4.256-.28-1.082-.681-1.866-1.204-2.352-.523-.504-1.129-.756-1.82-.756-.709 0-1.325.252-1.848.756-.523.486-.933 1.27-1.232 2.352-.28 1.083-.42 2.502-.42 4.256 0 1.736.14 3.155.42 4.256.299 1.102.709 1.914 1.232 2.436.523.523 1.139.784 1.848.784ZM73.611 57.832c-.952 0-1.801-.121-2.548-.364a7.528 7.528 0 0 1-1.904-.924 8.373 8.373 0 0 1-1.428-1.232l1.176-1.512a9.26 9.26 0 0 0 1.876 1.484c.728.43 1.624.644 2.688.644 1.083 0 1.97-.299 2.66-.896.69-.597 1.036-1.39 1.036-2.38 0-.71-.186-1.325-.56-1.848-.355-.541-.952-.961-1.792-1.26-.821-.299-1.941-.448-3.36-.448v-1.764c1.27 0 2.268-.15 2.996-.448.747-.299 1.279-.69 1.596-1.176A3.139 3.139 0 0 0 76.523 44c0-.877-.28-1.568-.84-2.072-.541-.504-1.288-.756-2.24-.756a4.36 4.36 0 0 0-2.072.504 6.88 6.88 0 0 0-1.736 1.316l-1.232-1.456A9.215 9.215 0 0 1 70.7 39.94c.84-.43 1.783-.644 2.828-.644 1.046 0 1.97.177 2.772.532.803.355 1.428.868 1.876 1.54.467.672.7 1.493.7 2.464 0 1.083-.299 1.97-.896 2.66-.597.69-1.381 1.223-2.352 1.596v.112a5.476 5.476 0 0 1 1.96.868 4.27 4.27 0 0 1 1.372 1.512c.355.616.532 1.335.532 2.156 0 1.064-.261 1.979-.784 2.744-.522.747-1.232 1.325-2.128 1.736-.896.41-1.885.616-2.968.616Zm14.282 0c-1.792 0-3.201-.803-4.228-2.408-1.008-1.624-1.512-3.93-1.512-6.916 0-3.005.504-5.292 1.512-6.86 1.027-1.568 2.436-2.352 4.228-2.352 1.773 0 3.164.793 4.172 2.38 1.027 1.568 1.54 3.845 1.54 6.832 0 2.987-.513 5.292-1.54 6.916-1.008 1.605-2.398 2.408-4.172 2.408Zm0-1.848c.69 0 1.297-.261 1.82-.784.523-.523.924-1.335 1.204-2.436.299-1.101.448-2.52.448-4.256 0-1.755-.15-3.173-.448-4.256-.28-1.083-.681-1.867-1.204-2.352-.522-.504-1.13-.756-1.82-.756-.71 0-1.325.252-1.848.756-.523.485-.933 1.27-1.232 2.352-.28 1.083-.42 2.501-.42 4.256 0 1.736.14 3.155.42 4.256.299 1.101.71 1.913 1.232 2.436.523.522 1.139.784 1.848.784Zm22.296 1.848c-1.624 0-3.062-.373-4.312-1.12-1.232-.765-2.203-1.857-2.912-3.276-.71-1.419-1.064-3.127-1.064-5.124 0-1.475.205-2.8.616-3.976.429-1.176 1.017-2.175 1.764-2.996a7.524 7.524 0 0 1 2.688-1.904c1.026-.43 2.146-.644 3.36-.644 1.269 0 2.333.233 3.192.7.877.467 1.577.99 2.1 1.568l-1.288 1.456a5.588 5.588 0 0 0-1.624-1.204c-.616-.317-1.391-.476-2.324-.476-1.232 0-2.306.308-3.22.924-.915.597-1.624 1.447-2.128 2.548-.486 1.101-.728 2.417-.728 3.948 0 1.55.233 2.884.7 4.004.485 1.12 1.176 1.988 2.072 2.604.914.616 2.025.924 3.332.924.653 0 1.278-.093 1.876-.28.597-.205 1.073-.476 1.428-.812v-4.788h-3.892v-1.932h6.02v7.728c-.579.616-1.363 1.13-2.352 1.54-.971.392-2.072.588-3.304.588Zm14.117-.084c-1.438 0-2.446-.42-3.024-1.26-.579-.84-.868-1.932-.868-3.276v-7.448h-2.016v-1.736l2.128-.14.28-4.368h1.932v4.368h3.696v1.876h-3.696v7.476c0 .821.149 1.465.448 1.932.317.467.868.7 1.652.7.242 0 .494-.019.756-.056.261-.056.522-.15.784-.28l.504 1.624a6.495 6.495 0 0 1-1.204.42 5.64 5.64 0 0 1-1.372.168Zm3.462 4.228 7.476-24.36h1.68l-7.476 24.36h-1.68Zm14.284-4.144c-.746 0-1.428-.15-2.044-.448a3.735 3.735 0 0 1-1.428-1.316c-.354-.579-.532-1.279-.532-2.1 0-1.53.672-2.688 2.016-3.472 1.344-.784 3.472-1.335 6.384-1.652a5.901 5.901 0 0 0-.28-1.624 2.365 2.365 0 0 0-.84-1.26c-.41-.317-.98-.476-1.708-.476-.784 0-1.521.15-2.212.448-.69.28-1.306.597-1.848.952l-.896-1.568c.411-.28.896-.55 1.456-.812a9.162 9.162 0 0 1 1.82-.672 7.51 7.51 0 0 1 2.072-.28c1.102 0 1.998.233 2.688.7.71.448 1.223 1.092 1.54 1.932.336.84.504 1.83.504 2.968v8.344h-1.904l-.196-1.624h-.084a12.072 12.072 0 0 1-2.1 1.4 5.307 5.307 0 0 1-2.408.56Zm.644-1.904c.672 0 1.298-.15 1.876-.448.598-.299 1.223-.737 1.876-1.316v-3.668c-1.53.187-2.744.43-3.64.728-.877.28-1.512.635-1.904 1.064-.392.43-.588.943-.588 1.54 0 .747.234 1.288.7 1.624.467.317 1.027.476 1.68.476ZM704.781 288.977c-1.792 0-3.201-.803-4.228-2.408-1.008-1.624-1.512-3.93-1.512-6.916 0-3.006.504-5.292 1.512-6.86 1.027-1.568 2.436-2.352 4.228-2.352 1.773 0 3.164.793 4.172 2.38 1.027 1.568 1.54 3.845 1.54 6.832 0 2.986-.513 5.292-1.54 6.916-1.008 1.605-2.399 2.408-4.172 2.408Zm0-1.848c.691 0 1.297-.262 1.82-.784.523-.523.924-1.335 1.204-2.436.299-1.102.448-2.52.448-4.256 0-1.755-.149-3.174-.448-4.256-.28-1.083-.681-1.867-1.204-2.352-.523-.504-1.129-.756-1.82-.756-.709 0-1.325.252-1.848.756-.523.485-.933 1.269-1.232 2.352-.28 1.082-.42 2.501-.42 4.256 0 1.736.14 3.154.42 4.256.299 1.101.709 1.913 1.232 2.436.523.522 1.139.784 1.848.784Zm22.295 1.848c-1.624 0-3.061-.374-4.312-1.12-1.232-.766-2.202-1.858-2.912-3.276-.709-1.419-1.064-3.127-1.064-5.124 0-1.475.206-2.8.616-3.976.43-1.176 1.018-2.175 1.764-2.996a7.538 7.538 0 0 1 2.688-1.904c1.027-.43 2.147-.644 3.36-.644 1.27 0 2.334.233 3.192.7.878.466 1.578.989 2.1 1.568l-1.288 1.456a5.557 5.557 0 0 0-1.624-1.204c-.616-.318-1.39-.476-2.324-.476-1.232 0-2.305.308-3.22.924-.914.597-1.624 1.446-2.128 2.548-.485 1.101-.728 2.417-.728 3.948 0 1.549.234 2.884.7 4.004.486 1.12 1.176 1.988 2.072 2.604.915.616 2.026.924 3.332.924a6.27 6.27 0 0 0 1.876-.28c.598-.206 1.074-.476 1.428-.812v-4.788h-3.892v-1.932h6.02v7.728c-.578.616-1.362 1.129-2.352 1.54-.97.392-2.072.588-3.304.588Zm14.118-.084c-1.438 0-2.446-.42-3.024-1.26-.579-.84-.868-1.932-.868-3.276v-7.448h-2.016v-1.736l2.128-.14.28-4.368h1.932v4.368h3.696v1.876h-3.696v7.476c0 .821.149 1.465.448 1.932.317.466.868.7 1.652.7.242 0 .494-.019.756-.056.261-.056.522-.15.784-.28l.504 1.624a6.495 6.495 0 0 1-1.204.42 5.64 5.64 0 0 1-1.372.168Zm3.461 4.228 7.476-24.36h1.68l-7.476 24.36h-1.68Zm14.285-4.144a4.63 4.63 0 0 1-2.044-.448 3.74 3.74 0 0 1-1.428-1.316c-.355-.579-.532-1.279-.532-2.1 0-1.531.672-2.688 2.016-3.472 1.344-.784 3.472-1.335 6.384-1.652a5.934 5.934 0 0 0-.28-1.624 2.363 2.363 0 0 0-.84-1.26c-.411-.318-.98-.476-1.708-.476-.784 0-1.521.149-2.212.448-.691.28-1.307.597-1.848.952l-.896-1.568c.411-.28.896-.551 1.456-.812a9.162 9.162 0 0 1 1.82-.672 7.493 7.493 0 0 1 2.072-.28c1.101 0 1.997.233 2.688.7.709.448 1.223 1.092 1.54 1.932.336.84.504 1.829.504 2.968v8.344h-1.904l-.196-1.624h-.084a12.09 12.09 0 0 1-2.1 1.4 5.314 5.314 0 0 1-2.408.56Zm.644-1.904a4.04 4.04 0 0 0 1.876-.448c.597-.299 1.223-.738 1.876-1.316v-3.668c-1.531.186-2.744.429-3.64.728-.877.28-1.512.634-1.904 1.064a2.204 2.204 0 0 0-.588 1.54c0 .746.233 1.288.7 1.624.467.317 1.027.476 1.68.476Z"
    />
    <path
      fill="#fff"
      fill-opacity={0.2}
      d="M754.728 333.787 56.993 70.389v263.398h697.735ZM754.457 501.693 56.35 564.662v177.257h698.107V501.693Z"
    />
    {/* Additional path elements truncated for brevity - they're all in the original file */}
  </svg>
);

export default function createTemplate(props: {
  markdown: string;
}): JSX.Element {
  // Parse with the extended component map
  const componentsWithExtras = {
    ...canonicalComponents,
    graphics: Graphic,
    calculator: World2Calculator,
  };

  const parsed = parse<GlobalScope, LocalScope>(
    props.markdown,
    componentsWithExtras
  );
  const item = parsed.global;

  return (
    <div class={`${item?.colorSpace} bg-neutral-150 min-h-screen`}>
      <main class="max-w-4xl mx-auto px-3 pb-7 relative">
        {/* Image */}
        {item?.image && (
          <img
            src={largeImageUrl(item.image)}
            alt={item.title}
            class="mx-auto mb-6 w-full object-contain"
          />
        )}

        {/* Back Navigation */}
        <A
          href={`/${item?.group}`}
          class="absolute top-3 left-3 flex items-center justify-start text-decent-900 mb-6 gap-2 uppercase text-shadow-md text-shadow-neutral-500"
        >
          <ChevronLeft /> <span>{item?.group?.replace(/-/g, ' ')}</span>
        </A>

        {/* Title Section */}
        <div class="text-center relative -top-9 md:-top-10 -mb-8">
          {item?.superTitle && (
            <p class="text-lg uppercase text-decent-900 mt-5 font-bold tracking-widest font-octa text-shadow-md text-shadow-neutral-500">
              {item.superTitle}
            </p>
          )}
          <h1 class="text-6xl md:text-8xl text-decent-900 font-octa font-bold leading-none text-shadow-md text-shadow-neutral-500">
            {item?.title}
          </h1>
          {item?.subTitle && (
            <p class="text-lg text-decent-900 mt-2 text-shadow-md text-shadow-neutral-500">
              {item.subTitle}
            </p>
          )}
        </div>

        {/* Description */}
        {item?.description && (
          <p class="text-center text-md font-sans text-decent-600 mb-2 mx-auto max-w-md">
            {Array.isArray(item.description)
              ? item.description.join(' ')
              : item.description}
          </p>
        )}

        {/* Reading Stats */}
        {item?.words && (
          <p class="text-center text-sm font-sans text-decent-500 mb-6">
            Read: {Math.round(item.words / 200)} min âœ§ Words:{' '}
            {item.words.toLocaleString()} âœ§ Chars:{' '}
            {item.chars?.toLocaleString()}
          </p>
        )}

        {/* Language Link */}
        {item?.ref && item?.language && (
          <div class="text-center mb-6">
            <A
              href={`/${item.group}/${item.ref}`}
              class="text-decent-600 hover:text-saturated-700"
            >
              {item.language === 'en'
                ? 'ðŸ‡©ðŸ‡ª Deutsche Version'
                : 'ðŸ‡¬ðŸ‡§ English Version'}
            </A>
          </div>
        )}

        {/* MDS Content Steps */}
        <div class="space-y-7">
          {Object.values(parsed.steps).map((step) => (
            <section class="mx-5 sm:mx-7 mb-7">
              <step.Body />
            </section>
          ))}
        </div>

        {/* Related Content */}
        {item?.related && item.related.length > 0 && (
          <div class="mt-12 pt-6 border-t border-decent-300">
            <h3 class="text-lg font-bold text-decent-700 mb-4">Related</h3>
            <div class="flex flex-wrap gap-2">
              {item.related.map((rel) => (
                <A
                  href={`/${rel}`}
                  class="text-sm text-decent-600 hover:text-saturated-700 underline"
                >
                  {rel}
                </A>
              ))}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
